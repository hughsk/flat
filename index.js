(function ( global, definition ){
  if ( typeof define === 'function' && define.amd ){
    define("flat", definition);
  } else if ( typeof module !== 'undefined' && module.exports ) {
    module.exports = definition();
  } else {
    global.flat = definition();
  }
})(this, function() {

  function flatten(target, opts) {
    opts = opts || {}

    var delimiter = opts.delimiter || '.'
    var output = {}

    function step(object, prev) {
      Object.keys(object).forEach(function(key) {
        var value = object[key]
        var isarray = opts.safe && Array.isArray(value)
        var type = Object.prototype.toString.call(value)
        var isobject = (
          type === "[object Object]" ||
          type === "[object Array]"
        )

        var newKey = prev
          ? prev + delimiter + key
          : key

        if (!isarray && isobject) {
          return step(value, newKey)
        }

        output[newKey] = value
      })
    }

    step(target)

    return output
  };

  function unflatten(target, opts) {
    opts = opts || {}

    var delimiter = opts.delimiter || '.'
    var result = {}

    if (Object.prototype.toString.call(target) !== '[object Object]') {
      return target
    }

    // safely ensure that the key is
    // an integer.
    function getkey(key) {
      var parsedKey = Number(key)

      return (
        isNaN(parsedKey) ||
        key.indexOf('.') !== -1
      ) ? key
        : parsedKey
    }

    Object.keys(target).forEach(function(key) {
      var split = key.split(delimiter)
      var key1 = getkey(split.shift())
      var key2 = getkey(split[0])
      var recipient = result

      while (key2 !== undefined) {
        if (recipient[key1] === undefined) {
          recipient[key1] = (
            typeof key2 === 'number' &&
            !opts.object ? [] : {}
          )
        }

        recipient = recipient[key1]
        if (split.length > 0) {
          key1 = getkey(split.shift())
          key2 = getkey(split[0])
        }
      }

      // unflatten again for 'messy objects'
      recipient[key1] = unflatten(target[key], opts)
    })

    return result
  };

  return {
    flatten: flatten,
    unflatten: unflatten
  };

});